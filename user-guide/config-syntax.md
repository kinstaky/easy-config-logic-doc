# 配置文件语法



## 配置文件构成

首选看一个示例，`examples/example_logic_1.txt`

```python
A2 = A0 & A3
Back = A0 & A3
C9 = clock_5MHz
D0 = (A0 & A3) / 100
C26 = D0 | C3
S0 = A2
S1 = D0
S2 = C4 | C7
```



不难发现，配置文件由**语句**（**sentence**）构成，**语句**的基本单位是**记号**（**token**），**记号**由字母、数字和下划线构成。所有的空格将被忽略。

配置中**记号**可以分为3类，**标识符**（**identifier**），**字面值**（**literal**）和**运算符**（**operator**）。在示例中，`A2`、`C9`、`clock_5MHz`、`D0`、`S0` 等都是**标识符**，`100` 是**字面值**，`=`、`&`、`|` 、`(`、`)`和`/`是**运算符**。

每一个**语句**都是赋值语句，即包含一个赋值运算符 `=` 和被其分开的**左式**和**右式**。**左式**包含且仅包含一个**标识符**，**右式**则是形式更自由的拓展的逻辑表达式。根据**左式**的不同，可以将语句分为**输入输出语句**、**分除语句**、**定标器语句**，其**左式**分别是**输入输出端口标识符**、**分除标识符**、**定标器标识符**。**语句**之间由换行符分隔，即没有行末标记同时每行最多有一个**语句**，允许有空行。



## 标识符

**标识符**的含义分为以下几类

+ 输入输出端口
+ 时钟
+ 定标器
+ 分除



### 输入输出端口

输入输出端口又可以分为3类

+ 前面板网口48路输入输出
+ 背板单路输入输出
+ 子板 lemo 口输入输出

硬件的前面板一共有12个用于逻辑输入输出的网口，每个网口有4路，总计48路。这12个网口又分为3组（A、B、C），每组4个网口16路。这48路从上到下分别命名为 A0-A15，B0-B15，C0-C15。

硬件的背板目前只有1路输入输出，命名为Back。

硬件的每个子板有8个 lemo 口输入输出，最多可以有3个子板，这些端口命名为A16-A31，B15-B31，C16-C31，以表示与前面板网口的并行关系。



### 时钟

**时钟标识符**都有相同的前缀`clock_`和后缀`Hz`，前缀和后缀之外部分表示该时钟信号的频率。频率可以是单纯的数值，比如100，表示时钟信号的频率是 100Hz ；也可以是带有字母后缀 `k` 或者 `M`，比如 `5k` 和 `5M`，分别表示时钟信号的频率是5000Hz 和 5,000,000 Hz。



### 定标器

定标器用于计数选定信号的频率，最多有32个定标器，所以将**定标器标识符**命名为 S0-S31。



### 分除

**分除标识符**用于表示选定信号分除后的信号，是一个中间变量，最多可以分除4个不同的信号，分除结果命名为 D0-D3。

## 字面值

**字面值**由数字组成，表示一个数，仅在**左式**是**分除**时出现在**右式**的末尾且紧跟在**运算符**`/`后面，其含义是对`/`前面的表达式分除**字面值**表示的倍数。



## 运算符

**运算符**分成3类

+ **逻辑运算符** `&`、`|`、`(`和`)`
+ **分除运算符** `/`
+ **赋值运算符** `=`

**逻辑运算符**顾名思义，表示信号之间的运算操作，`&`为与操作，`|`为或操作，操作顺序都是从左往右，且 `&` 和 `|` 优先级相同。`(` 和 `)` 配对出现，用于提高内部表达式的优先级。

**分除运算符**即除号 `/`，除号左边是被分除的信号，右边是分除的倍数，为**字面值**。分除即降低一个信号的频率，比如分除100倍，则左边信号触发100次后，分除结果信号才产生一次触发；如果分除前是1kHz，则分除100倍后为10Hz。

**赋值运算符**即等于号 `=`，每一个**语句**都包含且仅包含一个`=`，但根据**左式**可以分为3种情况

+ **左式**是**输入输出端口标识符**，表示该端口输出**右式**输入信号的运算结果
+ **左式**是**分除标识符**，表示给中间变量赋值
+ **左式**是**定标器标识符**，表示该定标器监测**右式**输入信号运算结果



## 输入输出语句

**输入输出语句**的**左式**为**输入输出端口标识符**，表示该端口是输出端口，输出的信号是**右式**的运算结果。**右式**可能为

+ 逻辑表达式，有可以分为两类
  + 纯逻辑表达式，仅包含**输入输出端口标识符**和**逻辑运算符**，表示各个端口作为输入，进行逻辑运算（与和或）；e.g. 示例中第一、二行
  + 含分除的逻辑运算表达式，此时**分除标识符**必须作为**右式**的第一个**记号**。**右式**可以仅有一个**分除标识符**，否则第二个**记号**必须是 `&` 或者 `|`，第三个**记号**开始的表达式必须是纯逻辑表达式；e.g. 示例第五行
+ 时钟表达式，仅有单个的**时钟标识符**，表示该端口输出一个时钟信号；e.g. 示例第三行

## 分除语句

**分除语句**的**左式**为**分除标识符**，**右式**最后一个**记号**是**字面值**表示分除的倍数，倒数第二个**记号**是**分除运算符**`/`，除此之外的记号构成纯逻辑表达式，用于表示将该表达式的逻辑运算结果分除**字面值**表示的倍数。e.g. 示例第四行



## 定标器语句

**定标器语句**的**左式**为**定标器标识符**，**右式**是逻辑表达式；e.g. 示例第六、七、八行。





## 上下文语法检查

配置文件中不同的**语句**需要满足以下上下文语法检查的条件

+ 一个端口不能同时作为输入和输出，但是一个输出端口可以出现在**定标器语句**的**右式**作为监测对象
+ 必须先在**分除语句**中定义**分除标识符**，再在其他**语句**的**右式**中使用





## 简单示例

### 前面板组合逻辑

我们首先从最简单的例子开始，一个**与门**

```python
A2 = A0 & A3
```

该**语句**表示前面板第1个端口和第4个端口的输入做**与**符合，符合结果在第3个端口输出。前面的硬件介绍提到过，对于 pixie16 插件，网口的第1路和第4路用于输出，第2路和第3路用于输入；因此，MZTIO 的网口如果是使用网线和 pixie16 的网口连接的，那么 MZTIO 的该网口的第1路和第4路就只能作为输入，而第2路和第3路只能作为输出。因此不难理解这个**语句**为什么初看那么怪异。



### 子板组合逻辑

如果要从子板输出输出，可以利用子板输入输出**标识符**

```python
C26 = C17 | C18
```

该**语句**表示第三块的子板第1个 lemo 口和第2个 lemo 的输入做**或**符合，符合结果在第6个 lemo 口输出。如果对硬件不熟悉，可以查看前面硬件介绍，如此即可理解硬件中子板只有8个 lemo 口，而对于最下面的对应前面板 C 组端口的子板，lemo 口从上往下对应网口 C1、C2、C5、C6、C9、C10、C13、C14



### 背板组合逻辑

如果要从背板输出单路的信号，只需设置**左式**为 `Back`

```python
Back = A0 & A3
```

该**语句**和[前面板组合逻辑](#前面板组合逻辑)一节中的只有**左式**不同，表示前面板第1个端口和第4个端口的输入做**与**符合，符合结果在背板输出。



### 时钟输出

只有前面板端口可以输出时钟信号

```python
C25 = clock_5MHz
```

该**语句**表示在第三块子板的第5个 lemo 口输出 5MHz 的时钟信号。





### 分除

 所谓分除，就是降低信号的频率，比如分除100倍，就是原信号每来100个才输出1个，如果原信号是1kHz，分除后就只有10Hz。首先要定义**分除标识符**，然后再使用。

```python
D0 = (A0 & A3) / 100
A2 = D0 | (A4 & A7)
```

上面第1个**语句**定义了分除`D0`，其将前面板第1个端口和第4个端口的输入的**与**符合结果分除100倍。第2个**语句**说明了怎么使用前一个**语句**定义的**分除标识符**，它表示前面板第5个端口和第8个端口的**与**符合结果和分除100倍后的前面板第1个端口和第4个端口的**与**符合的结果进行**或**符合，**或**符合的结果在第3个端口输出。不难发现，**分除语句**有别于其他**语句**，它需要联系上下文，要求先定义一个中间变量，因为这个中间变量无法直接观测，需要由另一个端口输出或者使用定标器监测。



### 定标器计数

定标器的监测对象为**右式**的运算结果，**右式**可以是输出端口，也可以是输入端口的组合，甚至是**分除标识符**

```python
S0 = A3
S1 = A0 & A3
S2 = D0
```

这里展示了3个定标器对不同的对象进行监测

+ 第1个**语句**表示监测前面板第4个端口的输入（输出）频率
+ 第2个**语句**表示监测前面板第1个端口和第4个端口的输入信号的**与**符合结果的频率
+ 第3个**语句**表示监测第1个分除信号的频率（这里仅作为示例，实际中使用应该先定义 `D0` ）



